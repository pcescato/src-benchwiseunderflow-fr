---
import BaseLayout from "@layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import dayjs from "@utils/dayjs";
import { DATE_FORMAT } from "@config";
import PostCard from "@/components/PostCard.astro";

const rawNotes = await getCollection("notes");

const notes = await Promise.all(
  rawNotes
    .filter((n) => !n.data.draft)
    .sort((a, b) => (b.data.pubDate?.getTime() ?? 0) - (a.data.pubDate?.getTime() ?? 0))
    .map(async (note) => {
      // ğŸ” On rÃ©cupÃ¨re le frontmatter gÃ©nÃ©rÃ© par le plugin remark
      const { remarkPluginFrontmatter } = await note.render();
      const totalCharCount = remarkPluginFrontmatter?.totalCharCount || 0;
      const readingTime = remarkPluginFrontmatter?.readingTime || 0;

      return {
        ...note,
        data: {
          ...note.data,
          totalCharCount,
          readingTime,
        },
      };
    })
);
---

<BaseLayout title="Notes dâ€™atelier">
  <section class="max-w-6xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-semibold mb-8">ğŸ› ï¸ Notes dâ€™atelier</h1>

    <div class="space-y-8">
      {notes.map((note) => (
        <PostCard
          basePath="notes"
          slug={note.slug}
          title={note.data.title}
          description={note.data.description ?? ""}
          image={note.data.image ?? "/image/notes-atelier.avif"}
          pubDate={note.data.pubDate ? dayjs(note.data.pubDate).format(DATE_FORMAT) : ""}
          categories={note.data.categories ?? []}
          word={note.data.totalCharCount}
          time={note.data.readingTime}
        />
      ))}
    </div>
  </section>
</BaseLayout>
