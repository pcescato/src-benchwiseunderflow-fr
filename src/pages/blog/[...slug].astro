---
import BaseLayout from "@layouts/BaseLayout.astro";
import License from "@components/widgets/License.astro";
import PostInfo from "@components/widgets/PostInfo.astro";
import PostFilter from "@components/widgets/PostFilter.astro";
import { getCollection, getEntry } from "astro:content";
import type { CollectionEntry } from "astro:content";
import dayjs from "@utils/dayjs";
import { DATE_FORMAT } from "@config";
import MainCard from "@/components/MainCard.astro";
import Comments from "../../components/Comments.astro";

// --- PARTIE 1 : DÃ©finition des Chemins (getStaticPaths) ---
export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((blog) => ({
    params: { slug: blog.slug },
  }));
}

// --- PARTIE 2 : RÃ©cupÃ©ration de l'Article et Rendu ---
const { slug } = Astro.params;
const blog: CollectionEntry<"blog"> | undefined = await getEntry("blog", slug);

// GESTION 404
if (!blog) {
  return new Response(null, {
    status: 404,
    statusText: "Not Found",
  });
}

// ðŸ›‘ MODIFICATION CLÃ‰ : ON DÃ‰STRUCTURE remarkPluginFrontmatter DEPUIS blog.render()
const { Content, remarkPluginFrontmatter, headings } = await blog.render();

// âœ… C'EST CET OBJET QUI CONTIENT LES DONNÃ‰ES CALCULÃ‰ES
// On utilise les variables pour plus de clartÃ©
const wordCount = remarkPluginFrontmatter.totalCharCount || 0;
const readingTime = remarkPluginFrontmatter.readingTime || 0;

// --- PARTIE 3 : DÃ©finition des Variables pour le Template ---
const displayDate = blog.data.pubDate ? dayjs(blog.data.pubDate).format(DATE_FORMAT) : "";

const image = new URL(`/og/${blog.slug}.png`, Astro.site).toString();
const url = new URL(`/blog/${blog.slug}`, Astro.url.origin);
---

<BaseLayout
Â  title={blog.data.title}
Â  description={blog.data.description}
Â  image={image}
Â  headings={headings}
Â  showTOC={true}
>
Â  <MainCard title={blog.data.title} description={blog.data.description} image={blog.data.image} infoIcon="lucide:info">
Â  Â  <PostInfo
Â  Â  Â  pubDate={displayDate}
Â  Â  Â  badge={blog.data.badge}
Â  Â  Â  word={wordCount} // On utilise la variable wordCount
Â  Â  Â  time={readingTime} // On utilise la variable readingTime
Â  Â  />

Â  Â  <div class="mb-6">
Â  Â  Â  <PostFilter categories={blog.data.categories} tags={blog.data.tags} />
Â  Â  </div>

Â  Â  <div class="mt-8">
Â  Â  Â  <div id="content" class="prose max-w-none prose-headings:scroll-mt-20 prose-img:rounded-xl prose-img:mx-auto">
Â  Â  Â  Â  <Content />
        <Comments />
Â  Â  Â  Â  <License
Â  Â  Â  Â  Â  url={url}
Â  Â  Â  Â  Â  title={blog.data.title}
Â  Â  Â  Â  Â  image={blog.data.image}
Â  Â  Â  Â  Â  pubDate={blog.data.pubDate}
Â  Â  Â  Â  Â  badge={blog.data.badge}
Â  Â  Â  Â  Â  categories={blog.data.categories}
Â  Â  Â  Â  Â  tags={blog.data.tags}
Â  Â  Â  Â  Â  word={wordCount} // On utilise la variable wordCount
Â  Â  Â  Â  Â  time={readingTime} // On utilise la variable readingTime
Â  Â  Â  Â  />
Â  Â  Â  </div>
Â  Â  </div>
Â  </MainCard>
</BaseLayout>